<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerencia | Belleza & Estilo</title>
    <link rel="stylesheet" href="/css/manager.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <aside class="sidebar">
        <div class="brand">
            <h2>Belleza & Estilo</h2>
            <p id="gerente-saludo" style="font-size: 0.9rem; color: #666; text-align: center; margin-top: -1.5rem; margin-bottom: 0.5rem;">
                Cargando...
            </p>
            <p id="sucursal-nombre" style="font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 2rem;">
                
            </p>
        </div>
        <nav>
            <button class="menu-btn active" onclick="showPanel('equipo', this)">
                <i class="fas fa-users"></i> Mi Equipo
            </button>
            <button class="menu-btn" onclick="showPanel('inventario', this)">
                <i class="fas fa-boxes"></i> Mi Inventario
            </button>
        </nav>
        <div style="margin-top: auto;">
            <a href="/logout" style="color: #999; text-decoration: none; font-size: 0.9rem; padding-left: 1rem;">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </a>
        </div>
    </aside>

    <main class="main-content">

        <!-- PANEL: EQUIPO -->
        <section id="equipo" class="panel-section active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 class="section-title">Gestión de Personal</h1>
                <button class="btn-save" onclick="toggleForm()">
                    <i class="fas fa-user-plus"></i> Registrar Empleado
                </button>
            </div>

            <!-- Formulario de Registro -->
            <div id="form-registro" class="form-container">
                <h3 style="margin-bottom: 1rem; color: var(--primary-dark);">Nuevo Ingreso</h3>
                <form id="formNuevoEmpleado" onsubmit="registrarEmpleado(event)">
                    <div class="form-row">
                        <input type="text" id="empCedula" class="input-std" placeholder="Cédula" required maxlength="10">
                        <input type="text" id="empTelefono" class="input-std" placeholder="Teléfono (09...)" maxlength="10">
                    </div>
                    <div class="form-row">
                        <input type="text" id="empNombres" class="input-std" placeholder="Nombres" required>
                        <input type="text" id="empApellidos" class="input-std" placeholder="Apellidos" required>
                    </div>
                    <div class="form-row">
                        <select id="empEspecialidad" class="input-std" required>
                            <option value="">Selecciona Especialidad</option>
                            <option value="Limpieza Facial">Limpieza Facial</option>
                            <option value="Depilacion Laser">Depilación Láser</option>
                            <option value="Manicure">Manicure</option>
                            <option value="Lifting de Pestañas">Lifting de Pestañas</option>
                        </select>
                    </div>
                    <div style="text-align: right; margin-top: 1rem;">
                        <button type="button" onclick="toggleForm()" style="background:none; border:none; color:#888; margin-right: 1rem; cursor:pointer;">Cancelar</button>
                        <button type="submit" class="btn-save">Guardar Registro</button>
                    </div>
                </form>
            </div>

            <!-- Grid de Empleados -->
            <div class="employees-grid" id="empleados-grid">
                <p style="color: #888; grid-column: 1/-1; text-align: center;">Cargando empleados...</p>
            </div>
        </section>

        <!-- PANEL: INVENTARIO -->
        <section id="inventario" class="panel-section">
            <h1 class="section-title">Inventario de la Sucursal</h1>
            <p style="margin-bottom: 2rem; color: #666;">
                Vista del stock local. Para solicitar reabastecimiento contacte al Administrador.
            </p>

            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Categoría</th>
                        <th>Stock Actual</th>
                        <th>Stock Mínimo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="inventario-body">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #888;">Cargando inventario...</td>
                    </tr>
                </tbody>
            </table>
        </section>

    </main>

    <script>
        // --- ESTADO GLOBAL ---
        let currentGerente = null;
        let empleados = [];
        let inventario = [];

        // Obtener ID del gerente desde la URL
        const params = new URLSearchParams(window.location.search);
        const gerenteId = params.get('id');

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!gerenteId) {
                alert("Error de sesión: No se identificó al gerente. Redirigiendo...");
                window.location.href = '/';
                return;
            }
            loadDashboardData();
        });

        // --- CARGAR DATOS DEL DASHBOARD ---
        async function loadDashboardData() {
            try {
                const res = await fetch(`/api/manager/data?id_gerente=${gerenteId}`);
                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Guardar datos
                currentGerente = data.gerente;
                empleados = data.empleados;
                inventario = data.inventario;

                // Actualizar UI
                document.getElementById('gerente-saludo').innerText = `Hola, ${currentGerente.nombre_gerente}`;
                document.getElementById('sucursal-nombre').innerText = `Gerencia: ${currentGerente.nombre_sucursal}`;
                document.title = `Gerencia | ${currentGerente.nombre_sucursal}`;

                renderEmpleados();
                renderInventario();

            } catch (error) {
                console.error("Error cargando dashboard:", error);
                document.getElementById('gerente-saludo').innerText = 'Error al cargar';
                document.getElementById('empleados-grid').innerHTML = `
                    <p style="color: red; grid-column: 1/-1; text-align: center;">
                        <i class="fas fa-exclamation-triangle"></i> ${error.message}
                    </p>`;
            }
        }

        // --- RENDER: EMPLEADOS ---
        function renderEmpleados() {
            const grid = document.getElementById('empleados-grid');
            grid.innerHTML = '';

            if (empleados.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #888;">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                        <p>No hay empleados registrados en esta sucursal.</p>
                        <p style="font-size: 0.85rem;">Usa el botón "Registrar Empleado" para añadir uno.</p>
                    </div>`;
                return;
            }

            empleados.forEach(emp => {
                const estadoColor = emp.estado === 'Activo' ? 'green' : 'red';
                const card = document.createElement('div');
                card.className = 'employee-card';
                card.innerHTML = `
                    <div style="width: 80px; height: 80px; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <i class="fas fa-user" style="font-size: 2rem; color: #ccc;"></i>
                    </div>
                    <h3>${emp.nombres} ${emp.apellidos}</h3>
                    <p style="color: #888; font-size: 0.9rem;">${emp.especialidad}</p>
                    <p style="font-size: 0.8rem; margin: 0.5rem 0; color: ${estadoColor};">● ${emp.estado}</p>
                    ${emp.telefono ? `<p style="font-size: 0.8rem; color: #666;"><i class="fas fa-phone"></i> ${emp.telefono}</p>` : ''}
                    <button class="btn-fire" onclick="despedirEmpleado(${emp.id_empleado}, '${emp.nombres} ${emp.apellidos}')">
                        <i class="fas fa-user-times"></i> Despedir
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        // --- RENDER: INVENTARIO ---
        function renderInventario() {
            const tbody = document.getElementById('inventario-body');
            tbody.innerHTML = '';

            if (inventario.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #888;">
                            No hay productos en el inventario de esta sucursal.
                        </td>
                    </tr>`;
                return;
            }

            inventario.forEach(item => {
                let estadoColor = 'green';
                if (item.estado === 'Bajo Stock') estadoColor = 'orange';
                if (item.estado === 'Sin Stock') estadoColor = 'red';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.producto}</td>
                    <td>${item.categoria}</td>
                    <td>${item.stock_actual} un.</td>
                    <td>${item.stock_minimo} un.</td>
                    <td style="color: ${estadoColor}; font-weight: 600;">${item.estado}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ACCIONES ---

        // Mostrar/Ocultar formulario
        function toggleForm() {
            const form = document.getElementById('form-registro');
            if (form.style.display === 'block') {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                form.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Registrar nuevo empleado
        async function registrarEmpleado(e) {
            e.preventDefault();

            const cedula = document.getElementById('empCedula').value.trim();
            
            // Validar que la cédula tenga 10 dígitos numéricos
            if (!/^\d{10}$/.test(cedula)) {
                alert('La cédula debe tener exactamente 10 dígitos numéricos');
                return;
            }

            const data = {
                id_sucursal: currentGerente.id_sucursal,
                cedula: cedula,
                nombres: document.getElementById('empNombres').value.trim(),
                apellidos: document.getElementById('empApellidos').value.trim(),
                especialidad: document.getElementById('empEspecialidad').value,
                telefono: document.getElementById('empTelefono').value.trim() || null
            };

            try {
                const res = await fetch('/api/manager/empleado', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert('✅ Empleado registrado exitosamente');
                    document.getElementById('formNuevoEmpleado').reset();
                    toggleForm();
                    loadDashboardData(); // Recargar lista
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión al registrar empleado');
            }
        }

        // Despedir empleado
        async function despedirEmpleado(idEmpleado, nombreCompleto) {
            const confirmacion = confirm(
                `⚠️ ADVERTENCIA:\n\n¿Estás seguro que deseas despedir a ${nombreCompleto}?\n\nEsta acción eliminará permanentemente su registro del sistema.`
            );

            if (!confirmacion) return;

            try {
                const res = await fetch(`/api/manager/empleado/${idEmpleado}`, {
                    method: 'DELETE'
                });

                const result = await res.json();

                if (result.success) {
                    alert(`El empleado ${nombreCompleto} ha sido dado de baja del sistema.`);
                    loadDashboardData(); // Recargar lista
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión al despedir empleado');
            }
        }

        // Cambiar paneles
        function showPanel(panelId, btn) {
            document.querySelectorAll('.panel-section').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
            btn.classList.add('active');
        }
    </script>
</body>
</html>